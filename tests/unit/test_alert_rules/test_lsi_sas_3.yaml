rule_files:
  - ../../../src/prometheus_alert_rules/lsi_sas_3.yaml

evaluation_interval: 1m

tests:

  - interval: 1m
    input_series:
      - series: 'sas3ircu_command_success{instance="ubuntu-0"}'
        values: '0x15' # error: Sas3ircuCommandFailed

    alert_rule_test:
      - eval_time: 0m
        alertname: Sas3ircuCommandFailed
        exp_alerts:
          - exp_labels:
              severity: critical
              instance: ubuntu-0
            exp_annotations:
              summary: Failed to run sas3ircu. (instance ubuntu-0)
              description: |
                Failed to get LSI SAS-3 controller information using sas3ircu.
                  INSTANCE = ubuntu-0
                  SUCCESS = 0
                  LABELS = map[__name__:sas3ircu_command_success instance:ubuntu-0]


  - interval: 1m
    input_series:
      - series: 'sas3ircu_command_success{instance="ubuntu-1"}'
        values: '1x15'
      - series: 'lsi_sas_3_controllers{instance="ubuntu-1"}'
        values: '0x15' # error: LSISAS3ControllerNotFound

    alert_rule_test:
      - eval_time: 0m
        alertname: LSISAS3ControllerNotFound
        exp_alerts:
          - exp_labels:
              severity: warning
              instance: ubuntu-1
            exp_annotations:
              summary: LSI SAS-3 controller not found. (instance ubuntu-1)
              description: |
                Cannot found LSI SAS-3 controller on this host machine.
                  INSTANCE = ubuntu-1
                  NUMBER_OF_CONTROLLERS = 0
                  LABELS = map[__name__:lsi_sas_3_controllers instance:ubuntu-1]


  - interval: 1m
    input_series:
      - series: 'sas3ircu_command_success{instance="ubuntu-2"}'
        values: '1x15'
      - series: 'lsi_sas_3_ir_volumes{controller_id="0", instance="ubuntu-2"}'
        values: '0x15' # error: LSISAS3IRVolumeNotFound

    alert_rule_test:
      - eval_time: 0m
        alertname: LSISAS3IRVolumeNotFound
        exp_alerts:
          - exp_labels:
              severity: warning
              controller_id: 0
              instance: ubuntu-2
            exp_annotations:
              summary: LSI SAS-3 IR volume not found. (instance ubuntu-2)
              description: |
                Cannot found LSI SAS-3 integrated RAID volumes on this controller.
                  CONTROLLER_ID = 0
                  NUMBER_OF_VOLUMES = 0
                  LABELS = map[__name__:lsi_sas_3_ir_volumes controller_id:0 instance:ubuntu-2]


  - interval: 1m
    input_series:
      - series: 'sas3ircu_command_success{instance="ubuntu-3"}'
        values: '1x15'
      - series: 'lsi_sas_3_ir_volume_info{instance="ubuntu-3", controller_id="0", volume_id="200", status="Okay (OKY)", size_mb="139236", boot="Primary", raid_level="RAID1", hard_disk="1:0,1:1"}'
        values: '1x15' # okay
      - series: 'lsi_sas_3_ir_volume_info{instance="ubuntu-3", controller_id="0", volume_id="201", status="Degraded (DGD)", size_mb="239236", boot="Primary", raid_level="RAID1", hard_disk="2:0,2:1"}'
        values: '1x15' # error: LSISAS3IRVolumeUnhealthy
      - series: 'lsi_sas_3_ir_volume_info{instance="ubuntu-3", controller_id="0", volume_id="202", status="Failed (FLD)", size_mb="339236", boot="Primary", raid_level="RAID1", hard_disk="3:0,3:1"}'
        values: '1x15' # error: LSISAS3IRVolumeUnhealthy
      - series: 'lsi_sas_3_ir_volume_info{instance="ubuntu-3", controller_id="0", volume_id="203", status="Missing (MIS)", size_mb="439236", boot="Primary", raid_level="RAID1", hard_disk="4:0,4:1"}'
        values: '1x15' # error: LSISAS3IRVolumeUnhealthy
      - series: 'lsi_sas_3_ir_volume_info{instance="ubuntu-3", controller_id="0", volume_id="204", status="Initializing (INIT)", size_mb="539236", boot="Primary", raid_level="RAID1", hard_disk="5:0,5:1"}'
        values: '1x15' # okay
      - series: 'lsi_sas_3_ir_volume_info{instance="ubuntu-3", controller_id="0", volume_id="205", status="Online (ONL)", size_mb="639236", boot="Primary", raid_level="RAID1", hard_disk="6:0,6:1"}'
        values: '1x15' # okay

    alert_rule_test:
      - eval_time: 0m
        alertname: LSISAS3IRVolumeUnhealthy
        exp_alerts:
          - exp_labels:
              severity: critical
              instance: ubuntu-3
              controller_id: 0
              volume_id: 201
              status: Degraded (DGD)
              size_mb: 239236
              boot: Primary
              raid_level: RAID1
              hard_disk: "2:0,2:1"
            exp_annotations:
              summary: LSI SAS-3 volume is not healthy. (instance ubuntu-3)
              description: |
                LSI SAS-3 volume is not in "Okay", "Initializing", or "Online" state. Please check the if the volume is working as expected.
                  CONTROLLER_ID = 0
                  VOLUME_ID = 201
                  STATUS = Degraded (DGD)
                  LABELS = map[__name__:lsi_sas_3_ir_volume_info boot:Primary controller_id:0 hard_disk:2:0,2:1 instance:ubuntu-3 raid_level:RAID1 size_mb:239236 status:Degraded (DGD) volume_id:201]
          - exp_labels:
              severity: critical
              instance: ubuntu-3
              controller_id: 0
              volume_id: 202
              status: Failed (FLD)
              size_mb: 339236
              boot: Primary
              raid_level: RAID1
              hard_disk: "3:0,3:1"
            exp_annotations:
              summary: LSI SAS-3 volume is not healthy. (instance ubuntu-3)
              description: |
                LSI SAS-3 volume is not in "Okay", "Initializing", or "Online" state. Please check the if the volume is working as expected.
                  CONTROLLER_ID = 0
                  VOLUME_ID = 202
                  STATUS = Failed (FLD)
                  LABELS = map[__name__:lsi_sas_3_ir_volume_info boot:Primary controller_id:0 hard_disk:3:0,3:1 instance:ubuntu-3 raid_level:RAID1 size_mb:339236 status:Failed (FLD) volume_id:202]
          - exp_labels:
              severity: critical
              instance: ubuntu-3
              controller_id: 0
              volume_id: 203
              status: Missing (MIS)
              size_mb: 439236
              boot: Primary
              raid_level: RAID1
              hard_disk: "4:0,4:1"
            exp_annotations:
              summary: LSI SAS-3 volume is not healthy. (instance ubuntu-3)
              description: |
                LSI SAS-3 volume is not in "Okay", "Initializing", or "Online" state. Please check the if the volume is working as expected.
                  CONTROLLER_ID = 0
                  VOLUME_ID = 203
                  STATUS = Missing (MIS)
                  LABELS = map[__name__:lsi_sas_3_ir_volume_info boot:Primary controller_id:0 hard_disk:4:0,4:1 instance:ubuntu-3 raid_level:RAID1 size_mb:439236 status:Missing (MIS) volume_id:203]


  - interval: 1m
    input_series:
      - series: 'sas3ircu_command_success{instance="ubuntu-4"}'
        values: '1x15'
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="0", size_mb_sectors="176940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Online (ONL)"}'
        values: '1x15' # okay
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="1", size_mb_sectors="276940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Hot Spare (HSP)"}'
        values: '1x15' # okay
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="2", size_mb_sectors="376940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Ready (RDY)"}'
        values: '1x15' # okay
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="4", size_mb_sectors="476940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Available (AVL)"}'
        values: '1x15' # error: LSISAS3PhysicalDiskUnhealthy
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="5", size_mb_sectors="576940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Failed (FLD)"}'
        values: '1x15' # error: LSISAS3PhysicalDiskUnhealthy
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="6", size_mb_sectors="676940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Missing (MIS)"}'
        values: '1x15' # error: LSISAS3PhysicalDiskUnhealthy
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="7", size_mb_sectors="776940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Standby (SBY)"}'
        values: '1x15' # error: LSISAS3PhysicalDiskUnhealthy
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="8", size_mb_sectors="876940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Out of Sync (OSY)"}'
        values: '1x15' # error: LSISAS3PhysicalDiskUnhealthy
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="9", size_mb_sectors="976940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Degraded (DGD)"}'
        values: '1x15' # error: LSISAS3PhysicalDiskUnhealthy
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="10", size_mb_sectors="1076940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Rebuilding (RBLD)"}'
        values: '1x15' # error: LSISAS3PhysicalDiskUnhealthy
      - series: 'lsi_sas_3_physical_device_info{instance="ubuntu-4", controller_id="1", enclosure_id="1", slot_id="11", size_mb_sectors="1176940/976773167", drive_type="SATA_HDD", protocol="SATA", state="Optimal (OPT)"}'
        values: '1x15' # okay

    alert_rule_test:
      - eval_time: 0m
        alertname: LSISAS3PhysicalDiskUnhealthy
        exp_alerts:
          - exp_labels:
              severity: critical
              instance: ubuntu-4
              controller_id: 1
              enclosure_id: 1
              slot_id: 4
              size_mb_sectors: 476940/976773167
              drive_type: SATA_HDD
              protocol: SATA
              state: Available (AVL)
            exp_annotations:
              summary: LSI SAS-3 physical disk is not healthy. (instance ubuntu-4)
              description: |
                LSI SAS-3 physical disk not in "Online", "Hot Spare", "Ready", or "Optimal" state. Please check the if the physical disk is working as expected.
                  CONTROLLER_ID = 1
                  ENCLOSURE_ID = 1
                  SLOT_ID = 4
                  STATE = Available (AVL)
                  LABELS = map[__name__:lsi_sas_3_physical_device_info controller_id:1 drive_type:SATA_HDD enclosure_id:1 instance:ubuntu-4 protocol:SATA size_mb_sectors:476940/976773167 slot_id:4 state:Available (AVL)]
          - exp_labels:
              severity: critical
              instance: ubuntu-4
              controller_id: 1
              enclosure_id: 1
              slot_id: 5
              size_mb_sectors: 576940/976773167
              drive_type: SATA_HDD
              protocol: SATA
              state: Failed (FLD)
            exp_annotations:
              summary: LSI SAS-3 physical disk is not healthy. (instance ubuntu-4)
              description: |
                LSI SAS-3 physical disk not in "Online", "Hot Spare", "Ready", or "Optimal" state. Please check the if the physical disk is working as expected.
                  CONTROLLER_ID = 1
                  ENCLOSURE_ID = 1
                  SLOT_ID = 5
                  STATE = Failed (FLD)
                  LABELS = map[__name__:lsi_sas_3_physical_device_info controller_id:1 drive_type:SATA_HDD enclosure_id:1 instance:ubuntu-4 protocol:SATA size_mb_sectors:576940/976773167 slot_id:5 state:Failed (FLD)]
          - exp_labels:
              severity: critical
              instance: ubuntu-4
              controller_id: 1
              enclosure_id: 1
              slot_id: 6
              size_mb_sectors: 676940/976773167
              drive_type: SATA_HDD
              protocol: SATA
              state: Missing (MIS)
            exp_annotations:
              summary: LSI SAS-3 physical disk is not healthy. (instance ubuntu-4)
              description: |
                LSI SAS-3 physical disk not in "Online", "Hot Spare", "Ready", or "Optimal" state. Please check the if the physical disk is working as expected.
                  CONTROLLER_ID = 1
                  ENCLOSURE_ID = 1
                  SLOT_ID = 6
                  STATE = Missing (MIS)
                  LABELS = map[__name__:lsi_sas_3_physical_device_info controller_id:1 drive_type:SATA_HDD enclosure_id:1 instance:ubuntu-4 protocol:SATA size_mb_sectors:676940/976773167 slot_id:6 state:Missing (MIS)]
          - exp_labels:
              severity: critical
              instance: ubuntu-4
              controller_id: 1
              enclosure_id: 1
              slot_id: 7
              size_mb_sectors: 776940/976773167
              drive_type: SATA_HDD
              protocol: SATA
              state: Standby (SBY)
            exp_annotations:
              summary: LSI SAS-3 physical disk is not healthy. (instance ubuntu-4)
              description: |
                LSI SAS-3 physical disk not in "Online", "Hot Spare", "Ready", or "Optimal" state. Please check the if the physical disk is working as expected.
                  CONTROLLER_ID = 1
                  ENCLOSURE_ID = 1
                  SLOT_ID = 7
                  STATE = Standby (SBY)
                  LABELS = map[__name__:lsi_sas_3_physical_device_info controller_id:1 drive_type:SATA_HDD enclosure_id:1 instance:ubuntu-4 protocol:SATA size_mb_sectors:776940/976773167 slot_id:7 state:Standby (SBY)]
          - exp_labels:
              severity: critical
              instance: ubuntu-4
              controller_id: 1
              enclosure_id: 1
              slot_id: 8
              size_mb_sectors: 876940/976773167
              drive_type: SATA_HDD
              protocol: SATA
              state: Out of Sync (OSY)
            exp_annotations:
              summary: LSI SAS-3 physical disk is not healthy. (instance ubuntu-4)
              description: |
                LSI SAS-3 physical disk not in "Online", "Hot Spare", "Ready", or "Optimal" state. Please check the if the physical disk is working as expected.
                  CONTROLLER_ID = 1
                  ENCLOSURE_ID = 1
                  SLOT_ID = 8
                  STATE = Out of Sync (OSY)
                  LABELS = map[__name__:lsi_sas_3_physical_device_info controller_id:1 drive_type:SATA_HDD enclosure_id:1 instance:ubuntu-4 protocol:SATA size_mb_sectors:876940/976773167 slot_id:8 state:Out of Sync (OSY)]
          - exp_labels:
              severity: critical
              instance: ubuntu-4
              controller_id: 1
              enclosure_id: 1
              slot_id: 9
              size_mb_sectors: 976940/976773167
              drive_type: SATA_HDD
              protocol: SATA
              state: Degraded (DGD)
            exp_annotations:
              summary: LSI SAS-3 physical disk is not healthy. (instance ubuntu-4)
              description: |
                LSI SAS-3 physical disk not in "Online", "Hot Spare", "Ready", or "Optimal" state. Please check the if the physical disk is working as expected.
                  CONTROLLER_ID = 1
                  ENCLOSURE_ID = 1
                  SLOT_ID = 9
                  STATE = Degraded (DGD)
                  LABELS = map[__name__:lsi_sas_3_physical_device_info controller_id:1 drive_type:SATA_HDD enclosure_id:1 instance:ubuntu-4 protocol:SATA size_mb_sectors:976940/976773167 slot_id:9 state:Degraded (DGD)]
          - exp_labels:
              severity: critical
              instance: ubuntu-4
              controller_id: 1
              enclosure_id: 1
              slot_id: 10
              size_mb_sectors: 1076940/976773167
              drive_type: SATA_HDD
              protocol: SATA
              state: Rebuilding (RBLD)
            exp_annotations:
              summary: LSI SAS-3 physical disk is not healthy. (instance ubuntu-4)
              description: |
                LSI SAS-3 physical disk not in "Online", "Hot Spare", "Ready", or "Optimal" state. Please check the if the physical disk is working as expected.
                  CONTROLLER_ID = 1
                  ENCLOSURE_ID = 1
                  SLOT_ID = 10
                  STATE = Rebuilding (RBLD)
                  LABELS = map[__name__:lsi_sas_3_physical_device_info controller_id:1 drive_type:SATA_HDD enclosure_id:1 instance:ubuntu-4 protocol:SATA size_mb_sectors:1076940/976773167 slot_id:10 state:Rebuilding (RBLD)]
